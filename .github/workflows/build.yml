name: Build SuperFlix com Inje√ß√£o Segura

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite executar manualmente

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Permite fazer push de volta

    steps:
      # PASSO 1: BAIXAR O C√ìDIGO
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Baixa TUDO, inclusive o template
          fetch-depth: 0

      # PASSO 2: CONFIGURAR JAVA
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Dar permiss√£o ao Gradle
        run: chmod +x gradlew

      # PASSO 3: VERIFICAR SE O TEMPLATE EXISTE
      - name: Verificar template
        run: |
          echo "=== VERIFICANDO TEMPLATE ==="
          TEMPLATE="SuperFlix/src/main/kotlin/com/SuperFlix/Config.kt.template"
          
          if [ -f "$TEMPLATE" ]; then
            echo "‚úÖ Template encontrado: $TEMPLATE"
            echo "üìÑ Conte√∫do (primeiras linhas):"
            head -10 "$TEMPLATE"
          else
            echo "‚ùå ERRO: Template N√ÉO encontrado!"
            echo "Crie o arquivo: $TEMPLATE"
            exit 1
          fi

      # PASSO 4: INJETAR A CHAVE DO SECRETS
      - name: Inject TMDB API Key
        run: |
          echo "=== INJETANDO CHAVE TMDB ==="
          
          # Caminhos dos arquivos
          TEMPLATE_FILE="SuperFlix/src/main/kotlin/com/SuperFlix/Config.kt.template"
          OUTPUT_FILE="SuperFlix/src/main/kotlin/com/SuperFlix/Config.kt"
          
          # Pega a chave do GitHub Secrets
          SECRET_KEY="${{ secrets.TMDB_API_KEY }}"
          
          echo "üîê Chave do Secrets: ${#SECRET_KEY} caracteres"
          
          # Verifica se a chave existe
          if [ -z "$SECRET_KEY" ]; then
            echo "‚ùå ERRO: TMDB_API_KEY n√£o definida no GitHub Secrets!"
            echo "V√° em Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "Adicione: TMDB_API_KEY = sua_chave_32_chars"
            exit 1
          fi
          
          # Verifica tamanho da chave
          if [ ${#SECRET_KEY} -ne 32 ]; then
            echo "‚ö†Ô∏è  AVISO: Chave tem ${#SECRET_KEY} chars (deveria ser 32)"
          fi
          
          # PASSO CR√çTICO: Substitui @@TMDB_API_KEY@@ pela chave real
          echo "üîÑ Substituindo placeholder..."
          sed "s/@@TMDB_API_KEY@@/$SECRET_KEY/g" "$TEMPLATE_FILE" > "$OUTPUT_FILE"
          
          # Verifica se funcionou
          echo "‚úÖ Arquivo gerado: $OUTPUT_FILE"
          echo "üîç Verificando inje√ß√£o..."
          
          if grep -q "$SECRET_KEY" "$OUTPUT_FILE"; then
            echo "üéâ SUCESSO! Chave injetada corretamente"
            echo "üìè Tamanho no arquivo: $(grep TMDB_API_KEY "$OUTPUT_FILE" | wc -c) bytes"
            
            # Mostra a linha (com m√°scara para seguran√ßa)
            LINE=$(grep "TMDB_API_KEY" "$OUTPUT_FILE")
            MASKED_LINE=$(echo "$LINE" | sed 's/"[^"]*\("[^"]*"\)/"***\1/')
            echo "üìù Linha: $MASKED_LINE"
          else
            echo "‚ùå FALHA: Chave N√ÉO foi injetada!"
            echo "Conte√∫do do arquivo:"
            cat "$OUTPUT_FILE"
            exit 1
          fi

      # PASSO 5: EXECUTAR O BUILD
      - name: Build do plugin
        run: |
          echo "=== EXECUTANDO BUILD ==="
          
          # Limpa builds anteriores
          ./gradlew :SuperFlix:clean
          
          # Executa o build
          echo "üîÑ Compilando..."
          ./gradlew :SuperFlix:assembleDebug
          
          # Verifica se o .cs3 foi gerado
          CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
          
          if [ -f "$CS3_FILE" ]; then
            echo "‚úÖ BUILD COMPLETO!"
            echo "üì¶ Arquivo gerado: $CS3_FILE"
            echo "üìè Tamanho: $(ls -lh "$CS3_FILE" | awk '{print $5}')"
          else
            echo "‚ùå ERRO: Nenhum arquivo .cs3 foi gerado!"
            exit 1
          fi

      # PASSO 6: VERIFICAR SE A CHAVE EST√Å NO .CS3
      - name: Verificar chave no output
        run: |
          echo "=== VERIFICANDO ARQUIVO FINAL ==="
          
          # Encontra o arquivo .cs3
          CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
          
          if [ -f "$CS3_FILE" ]; then
            echo "üîç Analisando: $CS3_FILE"
            
            # Procura pela chave (ou parte dela) no arquivo
            if strings "$CS3_FILE" | grep -q "b64d2f3a"; then
              echo "‚úÖ CONFIRMADO: Chave TMDB est√° presente no .cs3!"
              echo "üéâ PLUGIN PRONTO PARA USAR!"
            else
              echo "‚ö†Ô∏è  Chave n√£o encontrada no .cs3 (pode estar ofuscada)"
              echo "üìä Strings do arquivo (primeiras 20):"
              strings "$CS3_FILE" | head -20
            fi
          fi

      # PASSO 7: LIMPEZA (REMOVER ARQUIVOS SENS√çVEIS)
      - name: Limpeza p√≥s-build
        run: |
          echo "=== LIMPEZA SEGURA ==="
          
          # 1. Remove o arquivo Config.kt gerado (cont√©m a chave)
          if [ -f "SuperFlix/src/main/kotlin/com/SuperFlix/Config.kt" ]; then
            rm "SuperFlix/src/main/kotlin/com/SuperFlix/Config.kt"
            echo "üóëÔ∏è  Config.kt removido (cont√©m chave real)"
          fi
          
          # 2. Mant√©m o template para pr√≥ximos builds
          echo "üìÑ Template mantido: Config.kt.template"
          
          # 3. Remove logs sens√≠veis
          rm -f build.log gradle.properties local.properties
          echo "üßπ Arquivos tempor√°rios removidos"

      # PASSO 8 (OPCIONAL): COMMIT AUTOM√ÅTICO
      - name: Commit autom√°tico
        if: success()  # S√≥ executa se o build foi bem
        run: |
          echo "=== COMMIT AUTOM√ÅTICO ==="
          
          # Configura git
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"
          
          # Adiciona apenas o template (se foi modificado)
          git add SuperFlix/src/main/kotlin/com/SuperFlix/Config.kt.template
          
          # Faz commit
          git commit -m "build: Template atualizado [skip ci]" || echo "Nenhuma altera√ß√£o no template"
          
          # Faz push (opcional)
          # git push origin main || echo "Nada para push"
          
          echo "‚úÖ Processo completo!"
